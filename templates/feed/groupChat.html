{% extends "basefeed.html" %}
{% load static %}
{% block css %}

<style>
    .container {
        max-width: 1170px;
        margin: auto;
    }

    img {
        max-width: 100%;
    }

    .inbox_people {
        
        float: left;
        overflow: hidden;
        width: 40%;
        border-right: 1px solid #c4c4c4;
    }

    .inbox_msg {
        border: 1px solid #c4c4c4;
        clear: both;
        overflow: hidden;
    }

    .top_spac {
        margin: 20px 0 0;
    }


    .recent_heading {
        float: left;
        width: 40%;
    }

    .srch_bar {
        display: inline-block;
        text-align: right;
        width: 60%;
    }

    .headind_srch {
        padding: 10px 29px 10px 20px;
        overflow: hidden;
        border-bottom: 1px solid #c4c4c4;
    }

    .recent_heading h4 {
        color: #3e83c5;
        font-size: 21px;
        margin: auto;
    }

    .srch_bar input {
        border: 1px solid #cdcdcd;
        border-width: 0 0 1px 0;
        width: 80%;
        padding: 2px 0 4px 6px;
        background: none;
    }

    .srch_bar .input-group-addon button {
        background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
        border: medium none;
        padding: 0;
        color: #707070;
        font-size: 18px;
    }

    .srch_bar .input-group-addon {
        margin: 0 0 0 -27px;
    }

    .chat_ib h5 {
        font-size: 15px;
        color: #464646;
        margin: 0 0 8px 0;
    }

    .chat_ib h5 span {
        font-size: 13px;
        float: right;
    }

    .chat_ib p {
        font-size: 14px;
        color: #989898;
        margin: auto
    }

    .chat_img {
        float: left;
        width: 11%;
        position: relative;
    }

    .chat_ib {
        float: left;
        padding: 0 0 0 15px;
        width: 88%;
    }

    .chat_people {
        overflow: hidden;
        clear: both;
    }

    .chat_list {
        border-bottom: 1px solid #c4c4c4;
        margin: 0;
        padding: 18px 16px 10px;
        cursor: pointer;    
    }

    .inbox_chat {
        height: 550px;
        overflow-y: scroll;
    }

    .active_chat {
        background: #3e83c517;
    }

    .incoming_msg_img {
        display: inline-block;
        width: 6%;
    }

    .received_msg {
        display: inline-block;
        padding: 0 0 0 10px;
        vertical-align: top;
        width: 92%;
    }

    .received_withd_msg p {
        background: #89c34a none repeat scroll 0 0;
        border-radius: 3px;
        color: #fff;
        font-size: 14px;
        margin: 0;
        padding: 5px 10px 5px 12px;
        width: 100%;
    }

    .time_date {
        color: #747474;
        display: block;
        font-size: 11px;
        margin: 8px 0 0;
    }

    .received_withd_msg {
        width: 57%;
    }

    .mesgs {
        float: left;
        width: 60%;
    }

    .sent_msg p {
        background: #3e83c5 none repeat scroll 0 0;
        border-radius: 3px;
        font-size: 14px;
        margin: 0;
        color: #fff;
        padding: 5px 10px 5px 12px;
        width: 100%;
    }

    .outgoing_msg {
        overflow: hidden;
        margin: 26px 0 26px;
    }

    .sent_msg {
        float: right;
        width: 46%;
        display: inline-block;
        vertical-align: top;
        padding: 0 10px 0 0;
    }

    .input_msg_write input {
        background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
        border: medium none;
        color: #4c4c4c;
        font-size: 15px;
        min-height: 48px;
        width: 100%;
    }

    .type_msg {
        border-top: 1px solid #c4c4c4;
        position: relative;
        margin: 10px;
    }

    .msg_send_btn {
        background: #3e83c5 none repeat scroll 0 0;
        border: medium none;
        border-radius: 50%;
        color: #fff;
        cursor: pointer;
        font-size: 17px;
        height: 33px;
        position: absolute;
        right: 0;
        top: 11px;
        width: 33px;
    }

    .messaging {
        padding: 0 0 50px 0;
    }

    .msg_history {
        height: 516px;
        overflow-y: auto;
        padding: 20px;
    }

    .outgoing_msg_img {
        float: right;
        display: inline-block;
        width: 6%;
    }

    .user_status {
        background: #bebebe none repeat scroll 0 0;
        border-radius: 50%;
        bottom: 0;
        display: inline-block;
        height: 12px;
        padding: 2px;
        position: absolute;
        right: 0;
        width: 12px;
    }
    
    .user-online{
        background: #7FBA00;
    }

</style>
{% endblock %}
{% block content %}
<div class="gap gray-bg">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="row" id="page-contents">
                     <!-- sidebar left -->
            <div class="col-lg-3">
                <aside class="sidebar static">
                  <div class="widget stick-widget">
                    <h4 class="widget-title">Shortcuts</h4>
                    <ul class="naves">
                      <li>
                        <i class="ti-home"></i>
                        <a href="{% url 'home' %}" title="">Home</a>
                      </li>
                      <li>
                        <i class="ti-user"></i>
                        <a href="{% url 'edit_profile' %}" title="">My profile</a>
                      </li>
                      
                      <li>
                        <i class="ti-files"></i>
                        <a href="{% url 'user-posts' request.user.username %}" title="">My post</a>
                      </li>
                      <li>
                        <i class="ti-plus"></i>
                        <a href="{% url 'post-create' %}" title="">Add post</a>
                      </li>
                    
                     <li>
                        <i class="fa fa-shopping-cart" aria-hidden="true"></i>
                        <a href="{% url 'productsHome' %}" title="">Buy Products</a>
                      </li>
                        {% if user.is_authenticated and user.role == "seller" %}
                           <li>
                        <i class="fa fa-dollar" aria-hidden="true"></i>
                        <a href="{% url 'sellerDash' %}" title="">Sell Products</a>
                      </li>
                      {% endif %}
  
  
                      <li>
                        <i class="ti-bell"></i>
                        <a href="{% url 'show-notifications' %}" title="">Notifications
                          {% if count_notifications %}
            <span class="badge">({{ count_notifications }})</span>
          {% endif %} </a>
                      </li>
                      <li>
                        <i class="fa fa-comments-o"></i>
                        <a href="{% url 'groupChat' %}" >Group Chat</a>
                      </li>
                      <li>
                        <i class="ti-power-off"></i>
                        <a href="{% url 'logout' %}" title="">Logout</a>
                      </li>
                    </ul>
                  </div><!-- Shortcuts -->
         
                </aside>
              </div><!-- sidebar -->
              <!-- center middle  -->


              <div class="col-lg-9">
                <div class="container">
                    <div class="messaging">
                        <div class="inbox_msg">
                            <div class="inbox_people">
                                <div class="headind_srch">
                                    <div class="recent_heading">
                                        <h4>All Users</h4>
                                    </div>
                                </div>
                                <div class="inbox_chat">
                                    {% for user in users %}
                                    <div class="chat_list active_chat">
                                        
                                        <div class="chat_people">
                                            <div class="chat_img"> 
                                                <span class="user_status {% if user.social_status > 0 %}user-online{% endif %}" id="user_status_{{user.pk}}"></span>
                                                <img src="{{user.profile.image.url}}"
                                                    alt="sunil"> </div>
                                            <div class="chat_ib">
                                                <h5>{{user.username}} <span class="chat_date">Dec 25</span></h5>
                                                
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    
                                </div>
                            </div>
                            <div class="mesgs">
                                <div class="msg_history">
                                   
                                   
                                    
                                </div>
                                <div class="type_msg">
                                    <div class="input_msg_write">
                                        <input type="text" class="write_msg" id="chat-message-input" placeholder="Type a message" />
                                        <button class="msg_send_btn" id="chat-message-submit" type="button"><i class="fa fa-paper-plane-o"
                                                aria-hidden="true"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                
                
                        
                
                    </div>
                </div>

                
              </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block jsfiles %}
{% load static  %}
    <script src="{% static 'js/reconnecting-websocket.js'%}"></script>
    <script>
        var roomName="groupChat"
        var userName="{{user.username}}"
        var userPk= "{{user.pk}}"
       // const roomName = JSON.parse(document.getElementById('room-name').textContent);

        const chatSocket = new WebSocket(
            'wss://'
            + window.location.host
            + '/ws/feed/'
            + roomName
            + '/'
        );
       console.log(userName)
       chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
            console.log(data)

            if(data.command=='new_message')
            {         
                var content = data.message;
                var d = new Date(); // for now
                var image_url = data.image_url;
                var timestamp = data.timestamp
                
                
                if(userName==data.name){
                $(".msg_history").append(`
                <div class="outgoing_msg">
                                        <div class="outgoing_msg_img">
                                            <img src="${image_url}" alt="sunil">
                                        </div>
                                        <div class="sent_msg">
                                            <p>${content}</p>
                                            <span class="time_date"> ${timestamp} sent by ${data.name}</span>
                                        </div>
                                    </div>
                `)
                        }
                        else
                        {
                            $(".msg_history").append(`
                            <div class="incoming_msg">
                                                    <div class="incoming_msg_img">
                                                        <img src="${image_url}" alt="sunil">
                                                    </div>
                                                    <div class="received_msg">
                                                        <div class="received_withd_msg">
                                                            <p>${content}</p>
                                                            <span class="time_date">${timestamp}  sent by ${data.name}</span>
                                                        </div>
                                                    </div>
                                                </div>
                            `)
                        }
         
             $(".msg_history").animate({

                scrollTop:$(".msg_history")[0].scrollHeight
                },"slow");
            }

            else if(data.command=='fetch_old' && data.s_name == userName)
            {
               
                var msgs=JSON.parse(data['messages'])

                var count=Object.keys(msgs.messages).length;
                console.log(msgs.messages[0]['name']);
                console.log(msgs.messages)
                $(".msg_history").empty()
                for(var i=count-1;i >=0;i--)
                {
                    var image_url= msgs.messages[i].image_url;
                   var content = msgs.messages[i].content
                   var timestamp = msgs.messages[i].timestamp
                    if(userName==msgs.messages[i].name){
                $(".msg_history").append(`<div class="outgoing_msg">
                                        <div class="outgoing_msg_img">
                                            <img src="${image_url}" alt="sunil">
                                        </div>
                                        <div class="sent_msg">
                                            <p>${content}</p>
                                            <span class="time_date"> ${timestamp} sent by ${msgs.messages[i].name}</span>
                                        </div>
                                    </div>`)
            }
            else
            {
                $(".msg_history").append(`
                <div class="incoming_msg">
                                                    <div class="incoming_msg_img">
                                                        <img src="${image_url}" alt="sunil">
                                                    </div>
                                                    <div class="received_msg">
                                                        <div class="received_withd_msg">
                                                            <p>${content}</p>
                                                            <span class="time_date">${timestamp}  sent by ${msgs.messages[i].name}</span>
                                                        </div>
                                                    </div>
                                                </div>
                `)
            }
        }
            $(".msg_history").animate({

                            scrollTop:$(".msg_history")[0].scrollHeight
                            },"slow");
                        
                        }


            else if(data.command == "activate_user"){
                $("#user_status_"+data.pk).addClass("user-online")
            }
            else if(data.command == "dectivate_user"){
                $("#user_status_"+data.pk).removeClass("user-online")
            }
       }

       chatSocket.onopen = function(e) {

            chatSocket.send(JSON.stringify({
            'name': userName,
            'room': roomName,
            'command':'fetch_old',

            }));

            chatSocket.send(JSON.stringify({
            'pk': userPk,
            'room': roomName,
            'command':'activate_user',

            }));
            
        };
    chatSocket.onclose = function(e) {
        alert("closeing")
            console.error('Chat socket closed unexpectedly');
           
            chatSocket.send(JSON.stringify({
            'pk': userPk,
            'room': roomName,
            'command':'dectivate_user',

            }));
        };

        
        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
           
            chatSocket.send(JSON.stringify({
                'message': message,
                'from':userName,
                'command':'new_message'
            }));
            messageInputDom.value = '';
        };

 window.addEventListener("unload", function () {
    // if(socket.readyState == WebSocket.OPEN)
    //     socket.close();

    alert("sdksdlksdlk")
});
    </script>
{% endblock jsfiles %}